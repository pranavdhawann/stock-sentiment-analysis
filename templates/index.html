{% extends "base.html" %}

{% block title %}InfoEdge - Real-time News Analysis{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Hero Section -->
    <div class="hero-section text-white py-5">
        <div class="container">
            <div class="row justify-content-center text-center">
                <div class="col-lg-8">
                    <h1 class="text-5xl font-extrabold mb-4">
                        InfoEdge
                    </h1>
                    <p class="text-lg text-gray-200 mt-2 mb-5">
                        See beyond the headlines â€” real-time sentiment for smarter trades.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Section -->
    <div class="container search-container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                 <div class="card card-enhanced">
                     <div class="card-body p-4">
                         <!-- Search Form -->
                        <form id="sentimentForm" class="mb-4">
                            <div class="search-box-enhanced">
                <div class="input-group input-group-lg">
                    <span class="input-group-text">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text"
                           class="form-control"
                           id="stockSearch"
                           placeholder="Enter stock symbol or company name (e.g., AAPL, TSLA)"
                           autocomplete="off"
                           data-bs-toggle="dropdown"
                           data-bs-auto-close="false">
                </div>
                <!-- Sample stocks dropdown -->
                <div class="dropdown-menu w-100" id="sampleStocksDropdown">
                    <h6 class="dropdown-header">Popular Stocks</h6>
                    <a class="dropdown-item" href="#" data-symbol="AAPL">
                        <i class="fab fa-apple me-2"></i>Apple Inc. (AAPL)
                    </a>
                    <a class="dropdown-item" href="#" data-symbol="MSFT">
                        <i class="fab fa-microsoft me-2"></i>Microsoft Corporation (MSFT)
                    </a>
                    <a class="dropdown-item" href="#" data-symbol="GOOGL">
                        <i class="fab fa-google me-2"></i>Alphabet Inc. (GOOGL)
                    </a>
                    <a class="dropdown-item" href="#" data-symbol="AMZN">
                        <i class="fab fa-amazon me-2"></i>Amazon.com Inc. (AMZN)
                    </a>
                    <a class="dropdown-item" href="#" data-symbol="TSLA">
                        <i class="fas fa-car me-2"></i>Tesla Inc. (TSLA)
                    </a>
                    <a class="dropdown-item" href="#" data-symbol="META">
                        <i class="fab fa-meta me-2"></i>Meta Platforms Inc. (META)
                    </a>
                    <a class="dropdown-item" href="#" data-symbol="NVDA">
                        <i class="fas fa-microchip me-2"></i>NVIDIA Corporation (NVDA)
                    </a>
                    <a class="dropdown-item" href="#" data-symbol="NFLX">
                        <i class="fas fa-play me-2"></i>Netflix Inc. (NFLX)
                    </a>
                </div>
                                
                                <!-- Autocomplete Dropdown -->
                                <div id="autocompleteDropdown" class="autocomplete-dropdown"></div>
                            </div>
                        </form>

                        <!-- Loading Spinner -->
                        <div id="loadingSpinner" class="text-center d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Analyzing sentiment...</p>
                        </div>

                        <!-- Progress Bar -->
                        <div id="progressSection" class="d-none mt-4" style="display: none !important;">
                            <div class="card results-card">
                                <div class="card-body text-center p-4">
                                    <h5 class="card-title mb-3">Analyzing Sentiment</h5>
                                    <div class="progress mb-3" style="height: 20px; background-color: #f0f0f0;">
                                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                             role="progressbar" style="width: 0%; background-color: #007bff !important;"></div>
                                    </div>
                                    <p id="progressText" class="text-muted">Initializing analysis...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Results Section -->
                        <div id="resultsSection" class="d-none mt-4">
                            <!-- Sentiment Meter and Stock Chart Side by Side -->
                            <div class="row mb-4 equal-height">
                                <div class="col-md-4">
                                    <div class="card results-card">
                                        <div class="card-body text-center p-4">
                                            <h5 class="card-title mb-3">Overall Sentiment</h5>
                                            <div id="overallSentiment" class="sentiment-display"></div>
                                            <div id="confidenceScore" class="confidence-display mt-2"></div>
                                            
                                            <!-- Sentiment Meter -->
                                            <div class="mt-4">
                                                <h6 class="mb-3">Sentiment Meter</h6>
                                                <div class="sentiment-meter">
                                                    <div class="meter-container">
                                                        <div class="meter-scale">
                                                            <!-- Labels removed for cleaner look -->
                                                        </div>
                                                         <div class="meter-bar">
                                                             <div id="meterNeedle" class="meter-needle"></div>
                                                         </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                 <div class="col-md-8">
                                     <div class="card">
                                         <div class="card-body">
                                             <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <h5 id="stockPrice" class="mb-1">$0.00</h5>
                                                    <span id="priceChange" class="text-muted">+$0.00 (0.00%)</span>
                                                </div>
                                                <div class="col-md-6 text-end">
                                                    <small class="text-muted">Last 30 days</small>
                                                </div>
                                            </div>
                                            <canvas id="priceSentimentChart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                             <!-- Summarized Insights -->
                             <div class="mt-4">
                                 <h4 class="mb-3">
                                     <i class="fas fa-lightbulb text-warning me-2"></i>
                                     Summarized Insights
                                 </h4>
                                 <div class="card">
                                     <div class="card-body">
                                         <div id="insightsContent">
                                             <!-- Insights will be populated here -->
                                         </div>
                                     </div>
                                 </div>
                             </div>

                             <!-- News Items -->
                             <div class="mt-4">
                                 <div class="d-flex justify-content-between align-items-center mb-3">
                                     <h4 class="mb-0">Recent News Analysis</h4>
                                     <div class="scroll-indicator">
                                         <i class="fas fa-chevron-down text-muted"></i>
                                         <small class="text-muted ms-1">Scroll for more</small>
                                     </div>
                                 </div>
                                 <div class="card">
                                     <div class="card-body">
                                         <div id="newsItems" class="news-container"></div>
                                     </div>
                                 </div>
                             </div>
                        </div>

                        <!-- Error Message -->
                        <div id="errorMessage" class="alert alert-danger d-none" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="errorText"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('stockSearch');
    const autocompleteDropdown = document.getElementById('autocompleteDropdown');
    const sampleStocksDropdown = document.getElementById('sampleStocksDropdown');
    const sentimentForm = document.getElementById('sentimentForm');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const resultsSection = document.getElementById('resultsSection');
    const progressSection = document.getElementById('progressSection');
    const errorMessage = document.getElementById('errorMessage');
    
    let searchTimeout;
    
    // Show sample stocks when clicking on search input and clear existing results
    searchInput.addEventListener('focus', function() {
        // Clear existing results when focusing on search input
        autoReset();
        
        if (this.value.trim() === '') {
            sampleStocksDropdown.style.display = 'block';
        }
    });
    
    // Clear search input when clicking on it (if it has a value)
    searchInput.addEventListener('click', function() {
        if (this.value.trim() !== '') {
            this.value = '';
            autoReset();
            sampleStocksDropdown.style.display = 'block';
        }
    });
    
    // Hide sample stocks when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !sampleStocksDropdown.contains(e.target)) {
            sampleStocksDropdown.style.display = 'none';
        }
    });
    
    // Handle sample stock selection
    sampleStocksDropdown.addEventListener('click', function(e) {
        e.preventDefault();
        if (e.target.classList.contains('dropdown-item')) {
            const symbol = e.target.dataset.symbol;
            searchInput.value = symbol;
            sampleStocksDropdown.style.display = 'none';
            analyzeSentiment(symbol);
        }
    });
    
    // Search input with autocomplete (faster)
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        clearTimeout(searchTimeout);
        
        // Only auto-reset if there are existing results and user is typing a new query
        if (query.length > 0 && !resultsSection.classList.contains('d-none')) {
            autoReset();
        }
        
        // Hide sample stocks when typing
        sampleStocksDropdown.style.display = 'none';
        
        if (query.length < 1) {
            autocompleteDropdown.style.display = 'none';
            return;
        }
        
        searchTimeout = setTimeout(() => {
            fetch(`/api/search_stocks?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    displayAutocomplete(data);
                })
                .catch(error => {
                    console.error('Error fetching autocomplete:', error);
                });
        }, 150); // Faster response time
    });
    
    function displayAutocomplete(results) {
        if (results.length === 0) {
            autocompleteDropdown.style.display = 'none';
            return;
        }
        
        autocompleteDropdown.innerHTML = results.map(stock => `
            <div class="autocomplete-item" data-symbol="${stock.symbol}">
                <strong>${stock.symbol}</strong> - ${stock.name}
            </div>
        `).join('');
        
        autocompleteDropdown.style.display = 'block';
        
        // Add click handlers
        autocompleteDropdown.querySelectorAll('.autocomplete-item').forEach(item => {
            item.addEventListener('click', function() {
                const symbol = this.dataset.symbol;
                searchInput.value = symbol;
                autocompleteDropdown.style.display = 'none';
                analyzeSentiment(symbol); // Show news immediately on click
            });
        });
    }
    
    // Hide autocomplete when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !autocompleteDropdown.contains(e.target)) {
            autocompleteDropdown.style.display = 'none';
        }
    });
    
    // Form submission (prevent default form behavior)
    sentimentForm.addEventListener('submit', function(e) {
        e.preventDefault();
    });
    
    // Test function to verify elements exist
    function testElements() {
        console.log('Testing elements...');
        console.log('progressSection:', document.getElementById('progressSection'));
        console.log('progressBar:', document.getElementById('progressBar'));
        console.log('progressText:', document.getElementById('progressText'));
        console.log('overallSentiment:', document.getElementById('overallSentiment'));
        console.log('confidenceScore:', document.getElementById('confidenceScore'));
    }
    
     // Update sentiment meter
     function updateSentimentMeter(sentiment, confidence) {
         const meterNeedle = document.getElementById('meterNeedle');
         
         if (!meterNeedle) return;
         
         let position = 50; // Default to center (neutral)
         
         // Map sentiment to 5 sections: Very Negative, Negative, Neutral, Positive, Very Positive
         if (sentiment === 'Very Positive') {
             position = 75 + (confidence * 25); // 75% to 100%
         } else if (sentiment === 'Positive') {
             position = 50 + (confidence * 25); // 50% to 75%
         } else if (sentiment === 'Neutral') {
             position = 37.5 + (confidence * 12.5); // 37.5% to 50%
         } else if (sentiment === 'Negative') {
             position = 25 + (confidence * 12.5); // 25% to 37.5%
         } else if (sentiment === 'Very Negative') {
             position = confidence * 25; // 0% to 25%
         } else {
             // Fallback for unknown sentiment
             position = 50;
         }
         
         // Ensure position is within bounds
         position = Math.max(0, Math.min(100, position));
         
         meterNeedle.style.left = position + '%';
         
         console.log('Meter updated:', sentiment, confidence, position + '%');
     }
    
     // Theme toggle functionality
     const themeToggle = document.getElementById('themeToggle');
     const themeIcon = document.getElementById('themeIcon');
     const body = document.body;
     
     // Check for saved theme preference or default to light mode
     const currentTheme = localStorage.getItem('theme') || 'light';
     setTheme(currentTheme);
     
     themeToggle.addEventListener('click', function() {
         const newTheme = body.classList.contains('dark-theme') ? 'light' : 'dark';
         setTheme(newTheme);
         localStorage.setItem('theme', newTheme);
     });
     
     function setTheme(theme) {
         if (theme === 'dark') {
             body.classList.add('dark-theme');
             themeIcon.className = 'fas fa-moon';
         } else {
             body.classList.remove('dark-theme');
             themeIcon.className = 'fas fa-sun';
         }
     }
     
     // Run test after page loads
     setTimeout(testElements, 1000);
    
    // Analyze sentiment function
    
    // Auto-reset function (called when starting new search)
    function autoReset() {
        // Hide all sections
        resultsSection.classList.add('d-none');
        progressSection.style.display = 'none';
        progressSection.classList.add('d-none');
        errorMessage.classList.add('d-none');
        
        // Button removed - no need to reset button state
        
        // Reset progress bar
        const progressBar = document.getElementById('progressBar');
        if (progressBar) {
            progressBar.style.width = '0%';
        }
        
         // Reset meter
         const meterNeedle = document.getElementById('meterNeedle');
         if (meterNeedle) {
             meterNeedle.style.left = '50%';
         }
        
         // Clear news items
         const newsItemsContainer = document.getElementById('newsItems');
         if (newsItemsContainer) {
             newsItemsContainer.innerHTML = '';
         }
         
         // Clear insights
         const insightsContent = document.getElementById('insightsContent');
         if (insightsContent) {
             insightsContent.innerHTML = '';
         }
        
        
        // Clear stock price display
        const stockPrice = document.getElementById('stockPrice');
        const priceChange = document.getElementById('priceChange');
        if (stockPrice) {
            stockPrice.textContent = '$0.00';
        }
        if (priceChange) {
            priceChange.textContent = '+$0.00 (0.00%)';
            priceChange.className = 'text-muted';
        }
        
        // Destroy chart if it exists
        if (window.priceSentimentChartInstance) {
            window.priceSentimentChartInstance.destroy();
            window.priceSentimentChartInstance = null;
        }
    }
    
    // Reset all function (kept for compatibility)
    window.resetAll = function() {
        console.log('Resetting all...');
        
        // Clear search input
        searchInput.value = '';
        
        // Hide dropdowns
        autocompleteDropdown.style.display = 'none';
        sampleStocksDropdown.style.display = 'none';
        
        // Call auto-reset
        autoReset();
        
        console.log('Reset complete');
    };
    
    // Add click handler for autocomplete items to show news immediately
    function showNewsOnly(symbol) {
        // Show loading state
        loadingSpinner.classList.remove('d-none');
        resultsSection.classList.add('d-none');
        errorMessage.classList.add('d-none');
        
        fetch('/api/analyze_sentiment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ symbol: symbol })
        })
        .then(response => response.json())
        .then(data => {
            loadingSpinner.classList.add('d-none');
            
            if (data.error) {
                showError(data.error);
                return;
            }
            
            // Show only news, not sentiment
            displayNewsOnlyResults(data);
        })
        .catch(error => {
            loadingSpinner.classList.add('d-none');
            showError('An error occurred while fetching news. Please try again.');
            console.error('Error:', error);
        });
    }
    
     function displayNewsOnlyResults(data) {
         // Update stock price display
         updateStockPrice(data);
         
         // Create price-sentiment chart
         createPriceSentimentChart(data);
         
         // Display insights
         if (data.insights) {
             displayInsights(data.insights);
         }
         
         // Display news items with sentiment badges
        const newsItemsContainer = document.getElementById('newsItems');
        
        if (data.news_items && data.news_items.length > 0) {
            newsItemsContainer.innerHTML = data.news_items.map(item => `
                <div class="col-12 mb-3">
                    <div class="card news-card">
                        <div class="card-body p-4">
                            <h6 class="card-title fw-bold mb-3">${item.title}</h6>
                            <p class="card-text text-muted mb-3">${item.summary.substring(0, 120)}...</p>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="badge ${getSentimentBadgeColor(item.sentiment)} px-3 py-2">
                                    ${item.sentiment}
                                </span>
                                <small class="text-muted">${item.publisher}</small>
                            </div>
                            ${item.link ? `<a href="${item.link}" target="_blank" class="btn btn-outline-primary btn-sm">Read More</a>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            newsItemsContainer.innerHTML = '<div class="col-12"><p class="text-muted text-center">No news items found for this symbol.</p></div>';
        }
        
        // Show results section
        resultsSection.classList.remove('d-none');
        
        // Show sentiment card but make it smaller
        const sentimentCard = document.querySelector('.row .col-md-6:first-child');
        if (sentimentCard) {
            sentimentCard.style.display = 'block';
            sentimentCard.className = 'col-md-4'; // Make it smaller
        }
        
        // Make news count card smaller too
        
        // Don't clear search input - keep the stock name visible
        autocompleteDropdown.style.display = 'none';
    }
    
    function analyzeSentiment(symbol) {
        console.log('Starting sentiment analysis for:', symbol);
        
        // Show progress bar
        progressSection.style.display = 'block';
        progressSection.classList.remove('d-none');
        resultsSection.classList.add('d-none');
        errorMessage.classList.add('d-none');
        
        console.log('Progress section shown');
        
        // Button removed - no need to set button state
        
        // Simulate progress
        let progress = 0;
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        
        console.log('Progress elements:', progressBar, progressText);
        
        const progressInterval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
            
            if (progressText) {
                if (progress < 30) {
                    progressText.textContent = 'Fetching news articles...';
                } else if (progress < 60) {
                    progressText.textContent = 'Analyzing sentiment...';
                } else {
                    progressText.textContent = 'Processing results...';
                }
            }
        }, 200);
        
        fetch('/api/analyze_sentiment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ symbol: symbol })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Received data:', data);
            
            // Complete progress
            clearInterval(progressInterval);
            if (progressBar) {
                progressBar.style.width = '100%';
            }
            if (progressText) {
                progressText.textContent = 'Analysis complete!';
            }
            
            setTimeout(() => {
                // Button removed - no need to reset button state
                progressSection.style.display = 'none';
                progressSection.classList.add('d-none');
                
                if (data.error) {
                    console.log('Error in data:', data.error);
                    showError(data.error);
                    return;
                }
                
                console.log('Displaying results...');
                displayResults(data);
            }, 500);
        })
        .catch(error => {
            clearInterval(progressInterval);
            
            // Button removed - no need to reset button state
            progressSection.style.display = 'none';
            progressSection.classList.add('d-none');
            
            showError('An error occurred while analyzing sentiment. Please try again.');
            console.error('Error:', error);
        });
    }
    
    function displayResults(data) {
        console.log('displayResults called with:', data);
        
        // Show sentiment results (only after button click)
        const sentimentCard = document.querySelector('.row .col-md-6:first-child');
        if (sentimentCard) {
            sentimentCard.style.display = 'block';
            sentimentCard.className = 'col-md-6'; // Reset to full size
        }
        
        
        // Update overall sentiment
        const sentimentElement = document.getElementById('overallSentiment');
        const confidenceElement = document.getElementById('confidenceScore');
        console.log('Elements found:', sentimentElement, confidenceElement);
        
        if (sentimentElement) {
            sentimentElement.textContent = data.overall_sentiment || 'Neutral';
            sentimentElement.className = `sentiment-display ${getSentimentColor(data.overall_sentiment)}`;
        }
        
        if (confidenceElement) {
            confidenceElement.textContent = `Confidence: ${((data.confidence || 0) * 100).toFixed(1)}%`;
        }
        
        // Update sentiment meter
        updateSentimentMeter(data.overall_sentiment, data.confidence);
        
         // Update stock price display
         updateStockPrice(data);
         
         // Create price-sentiment chart
         createPriceSentimentChart(data);
         
         // Display insights
         if (data.insights) {
             displayInsights(data.insights);
         }
         
         // Display news items with sentiment
         const newsItemsContainer = document.getElementById('newsItems');
        if (data.news_items && data.news_items.length > 0) {
            newsItemsContainer.innerHTML = data.news_items.map(item => `
                <div class="col-12 mb-3">
                    <div class="card news-card">
                        <div class="card-body p-4">
                            <h6 class="card-title fw-bold mb-3">${item.title}</h6>
                            <p class="card-text text-muted mb-3">${item.summary.substring(0, 120)}...</p>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="badge ${getSentimentBadgeColor(item.sentiment)} px-3 py-2">
                                    ${item.sentiment}
                                </span>
                                <small class="text-muted">${item.publisher}</small>
                            </div>
                            ${item.link ? `<a href="${item.link}" target="_blank" class="btn btn-outline-primary btn-sm">Read More</a>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            newsItemsContainer.innerHTML = '<div class="col-12"><p class="text-muted text-center">No news items found for this symbol.</p></div>';
        }
        
         // Show results section
         resultsSection.classList.remove('d-none');
         
         // Don't clear search input - keep the stock name visible
         autocompleteDropdown.style.display = 'none';
     }
     
     // Display insights function
     function displayInsights(insights) {
         const insightsContent = document.getElementById('insightsContent');
         if (!insightsContent || !insights) return;
         
         const html = `
             <div class="row">
                 <div class="col-md-6 mb-4">
                     <h6 class="text-primary mb-3">
                         <i class="fas fa-chart-line me-2"></i>
                         Market Outlook
                     </h6>
                     <p class="mb-3">${insights.market_outlook}</p>
                     
                     <h6 class="text-success mb-3">
                         <i class="fas fa-arrow-up me-2"></i>
                         Opportunities
                     </h6>
                     <ul class="list-unstyled">
                         ${insights.opportunities.map(opp => `<li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>${opp}</li>`).join('')}
                     </ul>
                 </div>
                 
                 <div class="col-md-6 mb-4">
                     <h6 class="text-warning mb-3">
                         <i class="fas fa-key me-2"></i>
                         Key Points
                     </h6>
                     <ul class="list-unstyled">
                         ${insights.key_points.map(point => `<li class="mb-2"><i class="fas fa-bullseye text-warning me-2"></i>${point}</li>`).join('')}
                     </ul>
                     
                     <h6 class="text-danger mb-3">
                         <i class="fas fa-exclamation-triangle me-2"></i>
                         Risk Factors
                     </h6>
                     <ul class="list-unstyled">
                         ${insights.risk_factors.map(risk => `<li class="mb-2"><i class="fas fa-exclamation-circle text-danger me-2"></i>${risk}</li>`).join('')}
                     </ul>
                 </div>
             </div>
             
             <div class="row mt-3">
                 <div class="col-12">
                     <h6 class="text-info mb-3">
                         <i class="fas fa-newspaper me-2"></i>
                         News Sentiment Breakdown
                     </h6>
                     <div class="row text-center">
                         <div class="col-3">
                             <div class="bg-success text-white p-2 rounded">
                                 <strong>${insights.sentiment_summary.positive_news}</strong>
                                 <br><small>Positive</small>
                             </div>
                         </div>
                         <div class="col-3">
                             <div class="bg-warning text-dark p-2 rounded">
                                 <strong>${insights.sentiment_summary.neutral_news}</strong>
                                 <br><small>Neutral</small>
                             </div>
                         </div>
                         <div class="col-3">
                             <div class="bg-danger text-white p-2 rounded">
                                 <strong>${insights.sentiment_summary.negative_news}</strong>
                                 <br><small>Negative</small>
                             </div>
                         </div>
                         <div class="col-3">
                             <div class="bg-secondary text-white p-2 rounded">
                                 <strong>${insights.sentiment_summary.volatile_news}</strong>
                                 <br><small>Volatile</small>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
         `;
         
         insightsContent.innerHTML = html;
     }
    
    function showError(message) {
        document.getElementById('errorText').textContent = message;
        errorMessage.classList.remove('d-none');
    }
    
     function getSentimentColor(sentiment) {
         switch(sentiment.toLowerCase()) {
             case 'very positive': return 'text-success';
             case 'positive': return 'text-success';
             case 'negative': return 'text-danger';
             case 'very negative': return 'text-danger';
             case 'neutral': return 'text-warning';
             default: return 'text-muted';
         }
     }
    
     function getSentimentBadgeColor(sentiment) {
         switch(sentiment.toLowerCase()) {
             case 'very positive': return 'bg-success';
             case 'positive': return 'bg-success';
             case 'negative': return 'bg-danger';
             case 'very negative': return 'bg-danger';
             case 'neutral': return 'bg-warning text-dark';
             case 'volatile': return 'bg-secondary';
             default: return 'bg-secondary';
         }
     }
    
    // Update stock price display
    function updateStockPrice(data) {
        const stockPriceElement = document.getElementById('stockPrice');
        const priceChangeElement = document.getElementById('priceChange');
        
        if (stockPriceElement && data.current_price) {
            stockPriceElement.textContent = `$${data.current_price}`;
        }
        
        if (priceChangeElement && data.price_change !== undefined && data.price_change_percent !== undefined) {
            const isPositive = data.price_change >= 0;
            const sign = isPositive ? '+' : '';
            priceChangeElement.textContent = `${sign}$${data.price_change} (${sign}${data.price_change_percent}%)`;
            priceChangeElement.className = `text-muted ${isPositive ? 'price-positive' : 'price-negative'}`;
        }
    }
    
    // Create price-sentiment overlay chart
    function createPriceSentimentChart(data) {
        const canvas = document.getElementById('priceSentimentChart');
        if (!canvas || !data.chart_data || !data.sentiment_data) return;
        
        // Destroy existing chart if it exists
        if (window.priceSentimentChartInstance) {
            window.priceSentimentChartInstance.destroy();
            window.priceSentimentChartInstance = null;
        }
        
        const ctx = canvas.getContext('2d');
        
        const chartData = data.chart_data.map(item => ({
            x: new Date(item.date),
            y: item.price
        }));
        
        try {
            window.priceSentimentChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Stock Price ($)',
                    data: chartData,
                    borderColor: '#4F46E5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day'
                        },
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        title: {
                            display: true,
                            text: 'Stock Price ($)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });
        } catch (error) {
            console.error('Error creating chart:', error);
        }
    }
    
});
</script>
{% endblock %}
