{% extends "base.html" %}

{% block title %}Stock Sentiment Analysis - Real-time News Analysis{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Title Section -->
    <div class="title-section">
        <div class="container">
            <div class="row justify-content-center text-center">
                <div class="col-lg-10">
                    <h1 class="main-title" id="mainTitle" style="cursor: pointer;">
                        INFOEDGE
                    </h1>
                    <p class="main-subtitle">
                        See beyond the headlines â€” real-time sentiment for smarter trades
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Section -->
    <div class="container search-container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                 <div class="card card-enhanced">
                     <div class="card-body p-5">
                         <!-- Search Form -->
                        <form id="sentimentForm" class="mb-4">
                            <div class="search-box-enhanced">
                <div class="input-group input-group-xl">
                    <span class="input-group-text search-icon">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text"
                           class="form-control search-input"
                           id="stockSearch"
                           placeholder="Enter stock symbol or company name (e.g., AAPL, TSLA, Microsoft)"
                           autocomplete="off"
                           data-bs-toggle="dropdown"
                           data-bs-auto-close="false">
                </div>
                <!-- Simplified Sample stocks dropdown -->
                <div class="dropdown-menu w-100" id="sampleStocksDropdown">
                    <!-- US Stocks Section -->
                    <div id="usStocksSection">
                        <a class="dropdown-item" href="#" data-symbol="AAPL">Apple Inc. (AAPL)</a>
                        <a class="dropdown-item" href="#" data-symbol="MSFT">Microsoft Corporation (MSFT)</a>
                        <a class="dropdown-item" href="#" data-symbol="GOOGL">Alphabet Inc. (GOOGL)</a>
                        <a class="dropdown-item" href="#" data-symbol="AMZN">Amazon.com Inc. (AMZN)</a>
                        <a class="dropdown-item" href="#" data-symbol="TSLA">Tesla Inc. (TSLA)</a>
                        <a class="dropdown-item" href="#" data-symbol="META">Meta Platforms Inc. (META)</a>
                        <a class="dropdown-item" href="#" data-symbol="NVDA">NVIDIA Corporation (NVDA)</a>
                        <a class="dropdown-item" href="#" data-symbol="NFLX">Netflix Inc. (NFLX)</a>
                        <a class="dropdown-item" href="#" data-symbol="JPM">JPMorgan Chase & Co. (JPM)</a>
                        <a class="dropdown-item" href="#" data-symbol="V">Visa Inc. (V)</a>
                        <a class="dropdown-item" href="#" data-symbol="MA">Mastercard Inc. (MA)</a>
                        <a class="dropdown-item" href="#" data-symbol="PYPL">PayPal Holdings Inc. (PYPL)</a>
                        <a class="dropdown-item" href="#" data-symbol="JNJ">Johnson & Johnson (JNJ)</a>
                        <a class="dropdown-item" href="#" data-symbol="WMT">Walmart Inc. (WMT)</a>
                        <a class="dropdown-item" href="#" data-symbol="DIS">Walt Disney Company (DIS)</a>
                        <a class="dropdown-item" href="#" data-symbol="NKE">Nike Inc. (NKE)</a>
                        <a class="dropdown-item" href="#" data-symbol="XOM">Exxon Mobil Corporation (XOM)</a>
                        <a class="dropdown-item" href="#" data-symbol="BA">Boeing Company (BA)</a>
                        <a class="dropdown-item" href="#" data-symbol="CAT">Caterpillar Inc. (CAT)</a>
                        <a class="dropdown-item" href="#" data-symbol="UBER">Uber Technologies Inc. (UBER)</a>
                        <a class="dropdown-item" href="#" data-symbol="SHOP">Shopify Inc. (SHOP)</a>
                        <a class="dropdown-item" href="#" data-symbol="ZM">Zoom Video Communications Inc. (ZM)</a>
                        <a class="dropdown-item" href="#" data-symbol="PLTR">Palantir Technologies Inc. (PLTR)</a>
                    </div>
                    
                    <!-- Indian Stocks Section -->
                    <div id="indianStocksSection" style="display: none;">
                        <a class="dropdown-item" href="#" data-symbol="TCS">Tata Consultancy Services Ltd. (TCS)</a>
                        <a class="dropdown-item" href="#" data-symbol="INFY">Infosys Ltd. (INFY)</a>
                        <a class="dropdown-item" href="#" data-symbol="WIPRO">Wipro Ltd. (WIPRO)</a>
                        <a class="dropdown-item" href="#" data-symbol="HCLTECH">HCL Technologies Ltd. (HCLTECH)</a>
                        <a class="dropdown-item" href="#" data-symbol="TECHM">Tech Mahindra Ltd. (TECHM)</a>
                        <a class="dropdown-item" href="#" data-symbol="HDFCBANK">HDFC Bank Ltd. (HDFCBANK)</a>
                        <a class="dropdown-item" href="#" data-symbol="ICICIBANK">ICICI Bank Ltd. (ICICIBANK)</a>
                        <a class="dropdown-item" href="#" data-symbol="KOTAKBANK">Kotak Mahindra Bank Ltd. (KOTAKBANK)</a>
                        <a class="dropdown-item" href="#" data-symbol="AXISBANK">Axis Bank Ltd. (AXISBANK)</a>
                        <a class="dropdown-item" href="#" data-symbol="SBIN">State Bank of India (SBIN)</a>
                        <a class="dropdown-item" href="#" data-symbol="RELIANCE">Reliance Industries Ltd. (RELIANCE)</a>
                        <a class="dropdown-item" href="#" data-symbol="HINDUNILVR">Hindustan Unilever Ltd. (HINDUNILVR)</a>
                        <a class="dropdown-item" href="#" data-symbol="ITC">ITC Ltd. (ITC)</a>
                        <a class="dropdown-item" href="#" data-symbol="BHARTIARTL">Bharti Airtel Ltd. (BHARTIARTL)</a>
                        <a class="dropdown-item" href="#" data-symbol="MARUTI">Maruti Suzuki India Ltd. (MARUTI)</a>
                        <a class="dropdown-item" href="#" data-symbol="SUNPHARMA">Sun Pharmaceutical Industries Ltd. (SUNPHARMA)</a>
                        <a class="dropdown-item" href="#" data-symbol="DRREDDY">Dr. Reddy's Laboratories Ltd. (DRREDDY)</a>
                        <a class="dropdown-item" href="#" data-symbol="CIPLA">Cipla Ltd. (CIPLA)</a>
                        <a class="dropdown-item" href="#" data-symbol="DIVISLAB">Divi's Laboratories Ltd. (DIVISLAB)</a>
                        <a class="dropdown-item" href="#" data-symbol="BIOCON">Biocon Ltd. (BIOCON)</a>
                        <a class="dropdown-item" href="#" data-symbol="ONGC">Oil and Natural Gas Corporation Ltd. (ONGC)</a>
                        <a class="dropdown-item" href="#" data-symbol="IOC">Indian Oil Corporation Ltd. (IOC)</a>
                        <a class="dropdown-item" href="#" data-symbol="BPCL">Bharat Petroleum Corporation Ltd. (BPCL)</a>
                        <a class="dropdown-item" href="#" data-symbol="ADANIGREEN">Adani Green Energy Ltd. (ADANIGREEN)</a>
                        <a class="dropdown-item" href="#" data-symbol="TATAPOWER">Tata Power Company Ltd. (TATAPOWER)</a>
                        <a class="dropdown-item" href="#" data-symbol="ZOMATO">Zomato Ltd. (ZOMATO)</a>
                        <a class="dropdown-item" href="#" data-symbol="PAYTM">One97 Communications Ltd. (PAYTM)</a>
                        <a class="dropdown-item" href="#" data-symbol="POLICYBZR">PB Fintech Ltd. (POLICYBZR)</a>
                        <a class="dropdown-item" href="#" data-symbol="NAZARA">Nazara Technologies Ltd. (NAZARA)</a>
                    </div>
                </div>
                                
                                <!-- Autocomplete Dropdown -->
                                <div id="autocompleteDropdown" class="autocomplete-dropdown"></div>
                            </div>
                        </form>

                        <!-- Loading Spinner -->
                        <div id="loadingSpinner" class="text-center d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Analyzing sentiment...</p>
                        </div>

                        <!-- Progress Bar -->
                        <div id="progressSection" class="d-none mt-4" style="display: none !important;">
                            <div class="card results-card">
                                <div class="card-body text-center p-4">
                                    <h5 class="card-title mb-3">Analyzing Sentiment</h5>
                                    <div class="progress mb-3" style="height: 20px; background-color: #f0f0f0;">
                                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                             role="progressbar" style="width: 0%; background-color: #007bff !important;"></div>
                                    </div>
                                    <p id="progressText" class="text-muted">Initializing analysis...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Default Markets Section -->
                        <div id="defaultMarketsSection" class="mt-4">
                            <div class="markets-grid" id="defaultMarketsContainer">
                                <!-- Default market data will be loaded here -->
                            </div>
                        </div>

                        <!-- Results Section -->
                        <div id="resultsSection" class="d-none mt-4">
                            <!-- Sentiment Meter and Stock Chart Side by Side -->
                            <div class="row mb-4 equal-height">
                                <div class="col-md-4">
                                    <div class="card results-card">
                                        <div class="card-body text-center p-4">
                                            <div id="overallSentiment" class="sentiment-display"></div>
                                            
                                            <!-- Horizontal Sentiment Meter -->
                                            <div class="sentiment-meter-container" id="sentimentMeter_horizontal">
                                                <div class="sentiment-meter-header">
                                                    <div class="sentiment-label" id="sentimentLabel">Neutral</div>
                                                    <div class="sentiment-confidence" id="sentimentConfidence">58%</div>
                                                </div>
                                                
                                                <div class="sentiment-bar-container">
                                                    <div class="sentiment-bar-background">
                                                        <div class="sentiment-bar-fill" id="sentimentBarFill"></div>
                                                        <div class="sentiment-bar-indicator" id="sentimentBarIndicator"></div>
                                                    </div>
                                                    
                                                    <div class="sentiment-bar-labels">
                                                        <span class="bar-label negative">Bearish</span>
                                                        <span class="bar-label neutral">Neutral</span>
                                                        <span class="bar-label positive">Bullish</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                 <div class="col-md-8">
                                     <div class="card">
                                         <div class="card-body">
                                             <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <h5 id="stockPrice" class="mb-1">$0.00</h5>
                                                    <span id="priceChange" class="text-muted">+$0.00 (0.00%)</span>
                                                </div>
                                                <div class="col-md-6 text-end">
                                                    <small class="text-muted">Last 30 days</small>
                                                </div>
                                            </div>
                                            <div class="chart-container" style="position: relative; cursor: pointer;" title="Click to expand chart">
                                                <canvas id="priceSentimentChart" width="400" height="200"></canvas>
                                                <div class="chart-expand-overlay" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 8px; border-radius: 4px; font-size: 12px; opacity: 0; transition: opacity 0.3s;">
                                                    <i class="fas fa-expand"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                             <!-- Summarized Insights -->
                             <div class="mt-4">
                                 <h4 class="mb-3">
                                     <i class="fas fa-lightbulb text-warning me-2"></i>
                                     <span class="text-uppercase fw-bold">SUMMARIZED INSIGHTS</span>
                                 </h4>
                                 <div class="card">
                                     <div class="card-body">
                                         <div id="insightsContent">
                                             <!-- Insights will be populated here -->
                                         </div>
                                     </div>
                                 </div>
                             </div>

                             <!-- News Items -->
                             <div class="mt-4">
                                 <div class="news-header d-flex justify-content-between align-items-center mb-3">
                                     <h4 class="mb-0 text-uppercase fw-bold">RECENT NEWS ANALYSIS</h4>
                                     <div class="scroll-indicator d-none d-md-flex">
                                         <i class="fas fa-chevron-down text-muted"></i>
                                         <small class="text-muted ms-1">Scroll for more</small>
                                     </div>
                                 </div>
                                 <div class="card">
                                     <div class="card-body p-0">
                                         <div id="newsItems" class="news-container"></div>
                                     </div>
                                 </div>
                             </div>
                        </div>

                        <!-- Error Message -->
                        <div id="errorMessage" class="alert alert-danger d-none" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="errorText"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('stockSearch');
    const autocompleteDropdown = document.getElementById('autocompleteDropdown');
    const sampleStocksDropdown = document.getElementById('sampleStocksDropdown');
    const sentimentForm = document.getElementById('sentimentForm');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const resultsSection = document.getElementById('resultsSection');
    const progressSection = document.getElementById('progressSection');
    const errorMessage = document.getElementById('errorMessage');
    
    let searchTimeout;
    
    // Load default market data on page load (US markets by default)
    loadDefaultMarkets('US');
    toggleStockSections('US'); // Set initial stock sections
    
    // Make title clickable to reset search and go to home
    const mainTitle = document.getElementById('mainTitle');
    console.log('Main title element:', mainTitle); // Debug log
    
    if (mainTitle) {
        mainTitle.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Title clicked!'); // Debug log
            
            // Reset search input
            if (searchInput) {
                searchInput.value = '';
                console.log('Search input cleared'); // Debug log
            }
            
            // Hide all results and dropdowns
            if (resultsSection) {
                resultsSection.classList.add('d-none');
                console.log('Results section hidden'); // Debug log
            }
            if (autocompleteDropdown) {
                autocompleteDropdown.style.display = 'none';
            }
            if (sampleStocksDropdown) {
                sampleStocksDropdown.classList.remove('show');
                sampleStocksDropdown.style.display = 'none';
            }
            
            // Clear any error messages
            if (errorMessage) {
                errorMessage.classList.add('d-none');
            }
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    } else {
        console.error('Main title element not found!');
    }
    
    // Market location switch functionality
    const marketLocationSwitch = document.getElementById('marketLocationSwitch');
        const toggleIndicator = document.getElementById('toggleIndicator');
        
    if (marketLocationSwitch && toggleIndicator) {
        marketLocationSwitch.addEventListener('click', function() {
            // Toggle the active state
            const isActive = toggleIndicator.classList.contains('active');
            
            if (isActive) {
            // Switch to US
            toggleIndicator.classList.remove('active');
                loadDefaultMarkets('US');
                toggleStockSections('US');
            } else {
                // Switch to India
                toggleIndicator.classList.add('active');
                loadDefaultMarkets('IN');
                toggleStockSections('IN');
            }
            
            // Update sidebar market cards if they are visible
            const sidebarMarketCards = document.getElementById('sidebarMarketCards');
            if (sidebarMarketCards && sidebarMarketCards.style.display !== 'none') {
                showMarketCardsInSidebar();
            }
        });
        
        // Add click handlers for individual flags
        const flags = document.querySelectorAll('.flag');
        flags.forEach(flag => {
        flag.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent the button click from firing
            const country = this.dataset.country;
                
                if (country === 'US') {
                    toggleIndicator.classList.remove('active');
                    loadDefaultMarkets('US');
                    toggleStockSections('US');
                } else if (country === 'IN') {
                toggleIndicator.classList.add('active');
                    loadDefaultMarkets('IN');
                    toggleStockSections('IN');
                }
                
                // Update sidebar market cards if they are visible
                const sidebarMarketCards = document.getElementById('sidebarMarketCards');
                if (sidebarMarketCards && sidebarMarketCards.style.display !== 'none') {
                    showMarketCardsInSidebar();
                }
            });
        });
    }
    
    // Function to toggle stock sections based on country
    function toggleStockSections(country) {
        const usStocksSection = document.getElementById('usStocksSection');
        const indianStocksSection = document.getElementById('indianStocksSection');
        
        if (country === 'US') {
            if (usStocksSection) usStocksSection.style.display = 'block';
            if (indianStocksSection) indianStocksSection.style.display = 'none';
        } else if (country === 'IN') {
            if (usStocksSection) usStocksSection.style.display = 'none';
            if (indianStocksSection) indianStocksSection.style.display = 'block';
        }
    }
    
    // Function to show market cards in sidebar
    function showMarketCardsInSidebar() {
        const sidebarMarketCards = document.getElementById('sidebarMarketCards');
        const marketCardsContainer = document.getElementById('marketCardsContainer');
        
        if (!sidebarMarketCards || !marketCardsContainer) return;
        
        // Get current market location
        const currentCountry = document.getElementById('toggleIndicator').classList.contains('active') ? 'IN' : 'US';
        
        // Load market data and create sidebar cards
        fetch(`/api/get_default_markets?location=${currentCountry}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading market data for sidebar:', data.error);
                    return;
                }
                
                // Clear existing cards
                marketCardsContainer.innerHTML = '';
                
                // Create sidebar market cards
                data.markets.forEach(market => {
                    const card = document.createElement('div');
                    card.className = 'sidebar-market-card';
                    
                    const changeClass = market.change >= 0 ? 'positive' : 'negative';
                    const changeSymbol = market.change >= 0 ? '+' : '';
                    
                    card.innerHTML = `
                        <div class="sidebar-market-name">${market.name}</div>
                        <div class="sidebar-market-price">${market.currency}${market.price.toFixed(2)}</div>
                        <div class="sidebar-market-change ${changeClass}">
                            ${changeSymbol}${market.change.toFixed(2)} (${changeSymbol}${market.changePercent.toFixed(2)}%)
                        </div>
                    `;
                    
                    marketCardsContainer.appendChild(card);
                });
                
                // Show sidebar market cards
                sidebarMarketCards.style.display = 'block';
            })
            .catch(error => {
                console.error('Error fetching market data for sidebar:', error);
            });
    }
    
    // Show sample stocks when clicking on search input and clear existing results
    searchInput.addEventListener('focus', function() {
        // Clear existing results when focusing on search input
        autoReset();
        
        if (this.value.trim() === '') {
            sampleStocksDropdown.style.display = 'block';
            setTimeout(() => {
                sampleStocksDropdown.classList.add('show');
            }, 10);
        }
    });
    
    // Clear search input when clicking on it (if it has a value)
    searchInput.addEventListener('click', function() {
        if (this.value.trim() !== '') {
            this.value = '';
            autoReset();
            sampleStocksDropdown.style.display = 'block';
            setTimeout(() => {
                sampleStocksDropdown.classList.add('show');
            }, 10);
        }
    });
    
    // Hide sample stocks when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !sampleStocksDropdown.contains(e.target)) {
            sampleStocksDropdown.classList.remove('show');
            setTimeout(() => {
            sampleStocksDropdown.style.display = 'none';
            }, 300);
        }
    });
    
    // Handle sample stock selection
    sampleStocksDropdown.addEventListener('click', function(e) {
        e.preventDefault();
        if (e.target.classList.contains('dropdown-item')) {
            const symbol = e.target.dataset.symbol;
            searchInput.value = symbol;
            sampleStocksDropdown.classList.remove('show');
            setTimeout(() => {
            sampleStocksDropdown.style.display = 'none';
            }, 300);
            analyzeSentiment(symbol);
        }
    });
    
    // Search input with autocomplete (faster)
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        clearTimeout(searchTimeout);
        
        // Only auto-reset if there are existing results and user is typing a new query
        if (query.length > 0 && !resultsSection.classList.contains('d-none')) {
            autoReset();
        }
        
        // Hide sample stocks when typing
        sampleStocksDropdown.classList.remove('show');
        setTimeout(() => {
        sampleStocksDropdown.style.display = 'none';
        }, 300);
        
        if (query.length < 1) {
            autocompleteDropdown.style.display = 'none';
            return;
        }
        
        searchTimeout = setTimeout(() => {
            fetch(`/api/search_stocks?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    displayAutocomplete(data);
                })
                .catch(error => {
                    console.error('Error fetching autocomplete:', error);
                });
        }, 150); // Faster response time
    });
    
    function displayAutocomplete(results) {
        if (results.length === 0) {
            autocompleteDropdown.style.display = 'none';
            return;
        }
        
        autocompleteDropdown.innerHTML = results.map(stock => `
            <div class="autocomplete-item" data-symbol="${stock.symbol}">
                <strong>${stock.symbol}</strong> - ${stock.name}
            </div>
        `).join('');
        
        autocompleteDropdown.style.display = 'block';
        
        // Add click handlers
        autocompleteDropdown.querySelectorAll('.autocomplete-item').forEach(item => {
            item.addEventListener('click', function() {
                const symbol = this.dataset.symbol;
                searchInput.value = symbol;
                autocompleteDropdown.style.display = 'none';
                analyzeSentiment(symbol); // Show news immediately on click
            });
        });
    }
    
    // Hide autocomplete when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !autocompleteDropdown.contains(e.target)) {
            autocompleteDropdown.style.display = 'none';
        }
    });
    
    // Form submission (prevent default form behavior)
    sentimentForm.addEventListener('submit', function(e) {
        e.preventDefault();
    });
    
    // Test function to verify elements exist
    function testElements() {
        console.log('Testing elements...');
        console.log('progressSection:', document.getElementById('progressSection'));
        console.log('progressBar:', document.getElementById('progressBar'));
        console.log('progressText:', document.getElementById('progressText'));
        console.log('overallSentiment:', document.getElementById('overallSentiment'));
        console.log('confidenceScore:', document.getElementById('confidenceScore'));
    }
    
    
     // Update horizontal sentiment meter
     function updateHorizontalSentimentMeter(sentiment, confidence) {
         const sentimentLabel = document.getElementById('sentimentLabel');
         const sentimentConfidence = document.getElementById('sentimentConfidence');
         const sentimentBarFill = document.getElementById('sentimentBarFill');
         const sentimentBarIndicator = document.getElementById('sentimentBarIndicator');
         
         if (!sentimentLabel || !sentimentConfidence || !sentimentBarFill || !sentimentBarIndicator) return;
         
         // Calculate sentiment value (0-100)
         let value = 50; // Default neutral
         let color = '#F59E0B'; // Default neutral color
         
         if (sentiment === 'Very Positive') {
             value = 85 + (confidence * 15);
             color = '#10B981'; // Green
         } else if (sentiment === 'Positive') {
             value = 70 + (confidence * 15);
             color = '#10B981'; // Green
         } else if (sentiment === 'Neutral') {
             value = 40 + (confidence * 20);
             color = '#F59E0B'; // Orange
         } else if (sentiment === 'Negative') {
             value = 30 - (confidence * 15);
             color = '#EF4444'; // Red
         } else if (sentiment === 'Very Negative') {
             value = 15 - (confidence * 15);
             color = '#EF4444'; // Red
         }
         
         // Ensure value is within bounds
         value = Math.max(0, Math.min(100, value));
         
         // Update text labels with new terminology
         let displaySentiment = sentiment;
         if (sentiment === 'Very Positive' || sentiment === 'Positive') {
             displaySentiment = 'Bullish';
         } else if (sentiment === 'Very Negative' || sentiment === 'Negative') {
             displaySentiment = 'Bearish';
         } else if (sentiment === 'Neutral') {
             displaySentiment = 'Neutral';
         }
         sentimentLabel.textContent = displaySentiment;
         sentimentConfidence.textContent = Math.round(value) + '%';
         
         // Update bar fill and indicator position
         sentimentBarFill.style.width = value + '%';
         sentimentBarIndicator.style.left = value + '%';
         sentimentBarIndicator.style.borderColor = color;
         
         console.log('Horizontal meter updated:', sentiment, confidence, 'value:', value, 'color:', color);
     }
    
     // Theme functionality is now handled in main.js
     
     // Run test after page loads
     setTimeout(testElements, 1000);
    
    // Analyze sentiment function
    
    // Load default market data
    function loadDefaultMarkets(location = 'US') {
        const defaultMarketsContainer = document.getElementById('defaultMarketsContainer');
        const defaultMarketsSection = document.getElementById('defaultMarketsSection');
        
        if (!defaultMarketsContainer || !defaultMarketsSection) return;
        
        // Show loading state
        defaultMarketsContainer.innerHTML = `
            <div class="col-12 text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading markets...</span>
                </div>
                <p class="mt-2 text-muted">Loading market data...</p>
            </div>
        `;
        
        fetch(`/api/get_default_markets?location=${location}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                displayDefaultMarkets(data.markets);
            })
            .catch(error => {
                console.error('Error loading default markets:', error);
                defaultMarketsContainer.innerHTML = `
                    <div class="col-12 text-center">
                        <p class="text-muted">Unable to load market data. Please try again later.</p>
                    </div>
                `;
            });
    }
    
    // Display default market data
    function displayDefaultMarkets(markets) {
        const defaultMarketsContainer = document.getElementById('defaultMarketsContainer');
        
        if (!defaultMarketsContainer || !markets || markets.length === 0) return;
        
        const marketsHtml = markets.map(market => {
            const isPositive = market.price_change >= 0;
            const changeClass = isPositive ? 'text-success' : 'text-danger';
            const changeIcon = isPositive ? 'fa-arrow-up' : 'fa-arrow-down';
            
            return `
                <div class="market-card">
                    <div class="card-body">
                        <h5 class="card-title">${market.display_name}</h5>
                        <div class="market-price">
                            <div class="price-value">${market.currency}${market.current_price.toLocaleString()}</div>
                            <div class="price-change ${changeClass}">
                                <i class="fas ${changeIcon} me-1"></i>
                                ${market.currency}${Math.abs(market.price_change).toFixed(2)} (${Math.abs(market.price_change_percent).toFixed(2)}%)
                            </div>
                        </div>
                        <div class="market-chart">
                            <canvas id="chart-${market.symbol.replace(/[^a-zA-Z0-9]/g, '')}" width="500" height="350"></canvas>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        defaultMarketsContainer.innerHTML = marketsHtml;
        
        // Create charts for each market
        markets.forEach(market => {
            createMarketChart(market);
        });
        
        // Add click functionality to expand charts
        addChartExpansionFunctionality();
    }
    
    // Create chart for market data
    function createMarketChart(market) {
        const canvasId = `chart-${market.symbol.replace(/[^a-zA-Z0-9]/g, '')}`;
        const canvas = document.getElementById(canvasId);
        
        if (!canvas || !market.chart_data || market.chart_data.length === 0) return;
        
        const ctx = canvas.getContext('2d');
        
        const chartData = market.chart_data.map(item => ({
            x: new Date(item.date),
            y: item.price
        }));
        
        // Determine chart color based on price movement
        let chartColor = '#4F46E5'; // Default blue
        let backgroundColor = 'rgba(79, 70, 229, 0.1)';
        
        if (chartData.length >= 2) {
            const latestClose = chartData[chartData.length - 1].y;
            const previousClose = chartData[chartData.length - 2].y;
            
            if (latestClose >= previousClose) {
                chartColor = '#43a047'; // Green for rising
                backgroundColor = 'rgba(67, 160, 71, 0.1)';
            } else {
                chartColor = '#e53935'; // Red for falling
                backgroundColor = 'rgba(229, 57, 53, 0.1)';
            }
        }
        
        try {
            new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: market.display_name,
                        data: chartData,
                        borderColor: chartColor,
                        backgroundColor: backgroundColor,
                        borderWidth: 4,
                        tension: 0.3,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 8,
                        pointHoverBackgroundColor: chartColor,
                        pointHoverBorderColor: '#ffffff',
                        pointHoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MMM dd'
                                }
                            },
                            display: true,
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#6B7280',
                                font: {
                                    size: 11,
                                    weight: '500'
                                },
                                maxTicksLimit: 6
                            }
                        },
                        y: {
                            display: true,
                            position: 'right',
                            grid: {
                                color: 'rgba(107, 114, 128, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#6B7280',
                                font: {
                                    size: 11,
                                    weight: '500'
                                },
                                callback: function(value) {
                                    return market.currency + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: chartColor,
                            borderWidth: 2,
                            cornerRadius: 8,
                            displayColors: false,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                title: function(context) {
                                    return market.display_name;
                                },
                                label: function(context) {
                                    return `${market.currency}${context.parsed.y.toLocaleString()}`;
                                }
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error creating market chart:', error);
        }
    }
    
    // Add chart expansion functionality
    function addChartExpansionFunctionality() {
        const marketCharts = document.querySelectorAll('.market-chart');
        
        marketCharts.forEach(chart => {
            chart.addEventListener('click', function() {
                const canvas = this.querySelector('canvas');
                if (!canvas) return;
                
                // Get the market data from the canvas ID
                const marketSymbol = canvas.id.replace('chart-', '');
                const marketName = marketSymbol.replace(/([A-Z])/g, ' $1').trim();
                
                // Create modal for expanded chart
                const modal = document.createElement('div');
                modal.className = 'chart-modal';
                modal.innerHTML = `
                    <div class="chart-modal-content">
                        <div class="chart-modal-header">
                            <h5>${marketName} - Expanded View</h5>
                            <button class="chart-modal-close">&times;</button>
                        </div>
                        <div class="chart-modal-body">
                            <canvas id="expanded-${canvas.id}" width="800" height="400"></canvas>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Get original chart instance and recreate with larger size
                const originalChart = Chart.getChart(canvas);
                if (originalChart) {
                    const expandedCanvas = document.getElementById(`expanded-${canvas.id}`);
                    const expandedCtx = expandedCanvas.getContext('2d');
                    
                    // Clone the chart data
                    const chartData = JSON.parse(JSON.stringify(originalChart.data));
                    const chartOptions = JSON.parse(JSON.stringify(originalChart.options));
                    
                    // Update options for expanded view
                    chartOptions.responsive = true;
                    chartOptions.maintainAspectRatio = false;
                    chartOptions.scales.x.display = true;
                    chartOptions.scales.y.display = true;
                    chartOptions.plugins.legend.display = true;
                    chartOptions.plugins.tooltip.enabled = true;
                    
                    // Create new chart instance
                    new Chart(expandedCtx, {
                        type: originalChart.config.type,
                        data: chartData,
                        options: chartOptions
                    });
                }
                
                // Close modal functionality
                const closeBtn = modal.querySelector('.chart-modal-close');
                closeBtn.addEventListener('click', () => {
                    // Destroy the expanded chart before removing modal
                    const expandedCanvas = document.getElementById(`expanded-${canvas.id}`);
                    if (expandedCanvas) {
                        const expandedChart = Chart.getChart(expandedCanvas);
                        if (expandedChart) {
                            expandedChart.destroy();
                        }
                    }
                    document.body.removeChild(modal);
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        // Destroy the expanded chart before removing modal
                        const expandedCanvas = document.getElementById(`expanded-${canvas.id}`);
                        if (expandedCanvas) {
                            const expandedChart = Chart.getChart(expandedCanvas);
                            if (expandedChart) {
                                expandedChart.destroy();
                            }
                        }
                        document.body.removeChild(modal);
                    }
                });
            });
        });
    }
    
    // Auto-reset function (called when starting new search)
    function autoReset() {
        // Hide all sections
        resultsSection.classList.add('d-none');
        progressSection.style.display = 'none';
        progressSection.classList.add('d-none');
        errorMessage.classList.add('d-none');
        
        // Show main market section again
        const defaultMarketsSection = document.getElementById('defaultMarketsSection');
        if (defaultMarketsSection) {
            defaultMarketsSection.style.display = 'block';
        }
        
        // Hide sidebar market cards
        const sidebarMarketCards = document.getElementById('sidebarMarketCards');
        if (sidebarMarketCards) {
            sidebarMarketCards.style.display = 'none';
        }
        
        // Button removed - no need to reset button state
        
        // Reset progress bar
        const progressBar = document.getElementById('progressBar');
        if (progressBar) {
            progressBar.style.width = '0%';
        }
        
         // Reset meter
         const meterNeedle = document.getElementById('meterNeedle');
         if (meterNeedle) {
             meterNeedle.style.left = '50%';
         }
        
         // Clear news items
         const newsItemsContainer = document.getElementById('newsItems');
         if (newsItemsContainer) {
             newsItemsContainer.innerHTML = '';
         }
         
         // Clear insights
         const insightsContent = document.getElementById('insightsContent');
         if (insightsContent) {
             insightsContent.innerHTML = '';
         }
        
        
        // Clear stock price display
        const stockPrice = document.getElementById('stockPrice');
        const priceChange = document.getElementById('priceChange');
        if (stockPrice) {
            stockPrice.textContent = '$0.00';
        }
        if (priceChange) {
            priceChange.textContent = '+$0.00 (0.00%)';
            priceChange.className = 'text-muted';
        }
        
        // Destroy chart if it exists
        if (window.priceSentimentChartInstance) {
            window.priceSentimentChartInstance.destroy();
            window.priceSentimentChartInstance = null;
        }
    }
    
    // Reset all function (kept for compatibility)
    window.resetAll = function() {
        console.log('Resetting all...');
        
        // Clear search input
        searchInput.value = '';
        
        // Hide dropdowns
        autocompleteDropdown.style.display = 'none';
        sampleStocksDropdown.style.display = 'none';
        
        // Call auto-reset
        autoReset();
        
        // Default markets section stays visible
        
        console.log('Reset complete');
    };
    
    // Add click handler for autocomplete items to show news immediately
    function showNewsOnly(symbol) {
        // Show loading state
        loadingSpinner.classList.remove('d-none');
        resultsSection.classList.add('d-none');
        errorMessage.classList.add('d-none');
        
        fetch('/api/analyze_sentiment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ symbol: symbol })
        })
        .then(response => response.json())
        .then(data => {
            loadingSpinner.classList.add('d-none');
            
            if (data.error) {
                showError(data.error);
                return;
            }
            
            // Show only news, not sentiment
            displayNewsOnlyResults(data);
        })
        .catch(error => {
            loadingSpinner.classList.add('d-none');
            showError('An error occurred while fetching news. Please try again.');
            console.error('Error:', error);
        });
    }
    
     function displayNewsOnlyResults(data) {
         // Update stock price display
         updateStockPrice(data);
         
         // Create price-sentiment chart
         createPriceSentimentChart(data);
         
         // Display insights
         if (data.insights) {
             displayInsights(data.insights);
         }
         
         // Display news items with sentiment badges
        const newsItemsContainer = document.getElementById('newsItems');
        
        if (data.news_items && data.news_items.length > 0) {
            newsItemsContainer.innerHTML = data.news_items.map(item => `
                <div class="news-item">
                    <div class="card news-card-enhanced">
                        <div class="card-body">
                            <div class="news-header-mobile d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title fw-bold mb-0 flex-grow-1 me-2">${item.title}</h6>
                            </div>
                            <p class="card-text text-muted mb-3 news-snippet">${item.summary.substring(0, 200)}...</p>
                            <div class="news-footer d-flex justify-content-between align-items-center flex-wrap">
                                <div class="news-meta-row d-flex justify-content-between align-items-center w-100">
                                    <small class="text-muted publisher">${item.publisher}</small>
                                    <span class="badge ${getSentimentBadgeColor(item.sentiment)} sentiment-pill sentiment-badge">
                                        ${getDisplaySentiment(item.sentiment)}
                                    </span>
                                </div>
                                ${item.link ? `<a href="${item.link}" target="_blank" class="btn btn-outline-primary btn-sm mt-2 mt-md-0" role="button" aria-label="Read full article: ${item.title.substring(0, 50)}...">Read More</a>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            newsItemsContainer.innerHTML = '<div class="col-12"><p class="text-muted text-center">No news items found for this symbol.</p></div>';
        }
        
        // Show results section
        resultsSection.classList.remove('d-none');
        
        // Show sentiment card but make it smaller
        const sentimentCard = document.querySelector('.row .col-md-6:first-child');
        if (sentimentCard) {
            sentimentCard.style.display = 'block';
            sentimentCard.className = 'col-md-4'; // Make it smaller
        }
        
        // Make news count card smaller too
        
        // Don't clear search input - keep the stock name visible
        autocompleteDropdown.style.display = 'none';
    }
    
    function analyzeSentiment(symbol) {
        console.log('Starting sentiment analysis for:', symbol);
        
        // Show progress bar
        progressSection.style.display = 'block';
        progressSection.classList.remove('d-none');
        resultsSection.classList.add('d-none');
        errorMessage.classList.add('d-none');
        
        console.log('Progress section shown');
        
        // Button removed - no need to set button state
        
        // Simulate progress
        let progress = 0;
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        
        console.log('Progress elements:', progressBar, progressText);
        
        const progressInterval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
            
            if (progressText) {
                if (progress < 30) {
                    progressText.textContent = 'Fetching news articles...';
                } else if (progress < 60) {
                    progressText.textContent = 'Analyzing sentiment...';
                } else {
                    progressText.textContent = 'Processing results...';
                }
            }
        }, 200);
        
        fetch('/api/analyze_sentiment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ symbol: symbol })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Received data:', data);
            
            // Complete progress
            clearInterval(progressInterval);
            if (progressBar) {
                progressBar.style.width = '100%';
            }
            if (progressText) {
                progressText.textContent = 'Analysis complete!';
            }
            
            setTimeout(() => {
                // Button removed - no need to reset button state
                progressSection.style.display = 'none';
                progressSection.classList.add('d-none');
                
                if (data.error) {
                    console.log('Error in data:', data.error);
                    showError(data.error);
                    return;
                }
                
                console.log('Displaying results...');
                displayResults(data);
            }, 500);
        })
        .catch(error => {
            clearInterval(progressInterval);
            
            // Button removed - no need to reset button state
            progressSection.style.display = 'none';
            progressSection.classList.add('d-none');
            
            showError('An error occurred while analyzing sentiment. Please try again.');
            console.error('Error:', error);
        });
    }
    
    function displayResults(data) {
        console.log('displayResults called with:', data);
        
        // Hide main market section and move to sidebar
        const defaultMarketsSection = document.getElementById('defaultMarketsSection');
        if (defaultMarketsSection) {
            defaultMarketsSection.style.display = 'none';
        }
        
        // Show market cards in sidebar
        showMarketCardsInSidebar();
        
        // Show sentiment results (only after button click)
        const sentimentCard = document.querySelector('.row .col-md-6:first-child');
        if (sentimentCard) {
            sentimentCard.style.display = 'block';
            sentimentCard.className = 'col-md-6'; // Reset to full size
        }
        
        
        // Update overall sentiment
        const sentimentElement = document.getElementById('overallSentiment');
        const confidenceElement = document.getElementById('confidenceScore');
        console.log('Elements found:', sentimentElement, confidenceElement);
        
        if (sentimentElement) {
            sentimentElement.textContent = (data.overall_sentiment || 'Neutral').toUpperCase();
            sentimentElement.className = `sentiment-display ${getSentimentColor(data.overall_sentiment)}`;
        }
        
        if (confidenceElement) {
            confidenceElement.textContent = `Confidence: ${((data.confidence || 0) * 100).toFixed(1)}%`;
        }
        
        // Update horizontal sentiment meter
        updateHorizontalSentimentMeter(data.overall_sentiment, data.confidence);
        
         // Update stock price display
         updateStockPrice(data);
         
         // Create price-sentiment chart
         createPriceSentimentChart(data);
         
         // Display insights
         if (data.insights) {
             displayInsights(data.insights);
         }
         
         // Display news items with sentiment
         const newsItemsContainer = document.getElementById('newsItems');
        if (data.news_items && data.news_items.length > 0) {
            newsItemsContainer.innerHTML = data.news_items.map(item => `
                <div class="news-item">
                    <div class="card news-card-enhanced">
                        <div class="card-body">
                            <div class="news-header-mobile d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title fw-bold mb-0 flex-grow-1 me-2">${item.title}</h6>
                            </div>
                            <p class="card-text text-muted mb-3 news-snippet">${item.summary.substring(0, 200)}...</p>
                            <div class="news-footer d-flex justify-content-between align-items-center flex-wrap">
                                <div class="news-meta-row d-flex justify-content-between align-items-center w-100">
                                    <small class="text-muted publisher">${item.publisher}</small>
                                    <span class="badge ${getSentimentBadgeColor(item.sentiment)} sentiment-pill sentiment-badge">
                                        ${getDisplaySentiment(item.sentiment)}
                                    </span>
                                </div>
                                ${item.link ? `<a href="${item.link}" target="_blank" class="btn btn-outline-primary btn-sm mt-2 mt-md-0" role="button" aria-label="Read full article: ${item.title.substring(0, 50)}...">Read More</a>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            newsItemsContainer.innerHTML = '<div class="col-12"><p class="text-muted text-center">No news items found for this symbol.</p></div>';
        }
        
         // Show results section
         resultsSection.classList.remove('d-none');
         
         // Don't clear search input - keep the stock name visible
         autocompleteDropdown.style.display = 'none';
     }
     
     // Display insights function
     function displayInsights(insights) {
         const insightsContent = document.getElementById('insightsContent');
         if (!insightsContent || !insights) return;
         
         const html = `
             <div class="row">
                 <div class="col-md-6 mb-4">
                     <h6 class="text-primary mb-3">
                         <i class="fas fa-chart-line me-2"></i>
                         Market Outlook
                     </h6>
                     <p class="mb-3">${insights.market_outlook}</p>
                     
                     <h6 class="text-success mb-3">
                         <i class="fas fa-arrow-up me-2"></i>
                         Opportunities
                     </h6>
                     <ul class="list-unstyled">
                         ${insights.opportunities.map(opp => `<li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>${opp}</li>`).join('')}
                     </ul>
                 </div>
                 
                 <div class="col-md-6 mb-4">
                     <h6 class="text-warning mb-3">
                         <i class="fas fa-key me-2"></i>
                         Key Points
                     </h6>
                     <ul class="list-unstyled">
                         ${insights.key_points.map(point => `<li class="mb-2"><i class="fas fa-bullseye text-warning me-2"></i>${point}</li>`).join('')}
                     </ul>
                     
                     <h6 class="text-danger mb-3">
                         <i class="fas fa-exclamation-triangle me-2"></i>
                         Risk Factors
                     </h6>
                     <ul class="list-unstyled">
                         ${insights.risk_factors.map(risk => `<li class="mb-2"><i class="fas fa-exclamation-circle text-danger me-2"></i>${risk}</li>`).join('')}
                     </ul>
                 </div>
             </div>
             
         `;
         
         insightsContent.innerHTML = html;
     }
    
    function showError(message) {
        document.getElementById('errorText').textContent = message;
        errorMessage.classList.remove('d-none');
    }
    
     function getSentimentColor(sentiment) {
         switch(sentiment.toLowerCase()) {
             case 'very positive': return 'text-success';
             case 'positive': return 'text-success';
             case 'negative': return 'text-danger';
             case 'very negative': return 'text-danger';
             case 'neutral': return 'text-warning';
             default: return 'text-muted';
         }
     }
    
     function getSentimentBadgeColor(sentiment) {
         switch(sentiment.toLowerCase()) {
             case 'very positive': 
             case 'positive': 
             case 'bullish': return 'bg-success';
             case 'negative': 
             case 'very negative': 
             case 'bearish': return 'bg-danger';
             case 'neutral': return 'bg-warning text-dark';
             case 'volatile': return 'bg-secondary';
             default: return 'bg-secondary';
         }
     }
     
     function getDisplaySentiment(sentiment) {
         switch(sentiment.toLowerCase()) {
             case 'very positive': 
             case 'positive': return 'Bullish';
             case 'negative': 
             case 'very negative': return 'Bearish';
             case 'neutral': return 'Neutral';
             case 'volatile': return 'Volatile';
             default: return sentiment;
         }
     }
    
    // Update stock price display
    function updateStockPrice(data) {
        const stockPriceElement = document.getElementById('stockPrice');
        const priceChangeElement = document.getElementById('priceChange');
        
        if (stockPriceElement && data.current_price) {
            const currency = data.currency || '$';
            const price = parseFloat(data.current_price).toFixed(2);
            stockPriceElement.textContent = `${currency}${price}`;
        }
        
        if (priceChangeElement && data.price_change !== undefined && data.price_change_percent !== undefined) {
            const isPositive = data.price_change >= 0;
            const sign = isPositive ? '+' : '';
            const currency = data.currency || '$';
            const priceChange = parseFloat(data.price_change).toFixed(2);
            const priceChangePercent = parseFloat(data.price_change_percent).toFixed(2);
            priceChangeElement.textContent = `${sign}${currency}${priceChange} (${sign}${priceChangePercent}%)`;
            priceChangeElement.className = `text-muted ${isPositive ? 'price-positive' : 'price-negative'}`;
        }
    }
    
    // Create price-sentiment overlay chart
    function createPriceSentimentChart(data) {
        const canvas = document.getElementById('priceSentimentChart');
        if (!canvas || !data.chart_data || !data.sentiment_data) return;
        
        // Destroy existing chart if it exists
        if (window.priceSentimentChartInstance) {
            window.priceSentimentChartInstance.destroy();
            window.priceSentimentChartInstance = null;
        }
        
        const ctx = canvas.getContext('2d');
        
        const chartData = data.chart_data.map(item => ({
            x: new Date(item.date),
            y: item.price
        }));
        
        // Determine chart color based ONLY on stock movement (latest vs previous close)
        let chartColor = '#4F46E5'; // Default blue
        let backgroundColor = 'rgba(79, 70, 229, 0.1)';
        
        console.log('Chart data points:', chartData.length);
        
        // Calculate stock movement from latest close vs previous close
        if (chartData.length >= 2) {
            const latestClose = chartData[chartData.length - 1].y;
            const previousClose = chartData[chartData.length - 2].y;
            const priceChange = latestClose - previousClose;
            
            console.log('Stock movement:', previousClose, 'to', latestClose, 'change:', priceChange.toFixed(2));
            
            if (latestClose >= previousClose) {
                chartColor = '#43a047'; // Green for rising stock
                backgroundColor = 'rgba(67, 160, 71, 0.1)';
                console.log('Setting chart to GREEN for rising stock');
            } else {
                chartColor = '#e53935'; // Red for falling stock
                backgroundColor = 'rgba(229, 57, 53, 0.1)';
                console.log('Setting chart to RED for falling stock');
            }
        } else {
            console.log('Not enough data points for movement calculation');
        }
        
        try {
            window.priceSentimentChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Stock Price ($)',
                    data: chartData,
                    borderColor: chartColor,
                    backgroundColor: backgroundColor,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day'
                        },
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        title: {
                            display: true,
                            text: 'Stock Price ($)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });
        } catch (error) {
            console.error('Error creating chart:', error);
        }
        
        // Add expandable functionality to the main stock chart
        addStockChartExpansionFunctionality();
    }
    
    // Add expandable functionality to the main stock chart
    function addStockChartExpansionFunctionality() {
        const chartContainer = document.querySelector('.chart-container');
        if (!chartContainer) return;
        
        chartContainer.addEventListener('click', function() {
            const canvas = this.querySelector('canvas');
            if (!canvas) return;
            
            // Get the stock symbol from the search input
            const stockSymbol = document.getElementById('stockSearch').value || 'Stock';
            
            // Create modal for expanded chart
            const modal = document.createElement('div');
            modal.className = 'chart-modal';
            modal.innerHTML = `
                <div class="chart-modal-content">
                    <div class="chart-modal-header">
                        <h5>${stockSymbol} - Price Chart (Expanded View)</h5>
                        <button class="chart-modal-close">&times;</button>
                    </div>
                    <div class="chart-modal-body">
                        <canvas id="expanded-priceSentimentChart" width="800" height="500"></canvas>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Get original chart instance and recreate with larger size
            const originalChart = window.priceSentimentChartInstance;
            if (originalChart) {
                const expandedCanvas = document.getElementById('expanded-priceSentimentChart');
                const expandedCtx = expandedCanvas.getContext('2d');
                
                // Clone the chart data
                const chartData = JSON.parse(JSON.stringify(originalChart.data));
                const chartOptions = JSON.parse(JSON.stringify(originalChart.options));
                
                // Update options for expanded view
                chartOptions.responsive = true;
                chartOptions.maintainAspectRatio = false;
                chartOptions.scales.x.display = true;
                chartOptions.scales.y.display = true;
                chartOptions.plugins.legend.display = true;
                chartOptions.plugins.tooltip.enabled = true;
                
                // Create new chart instance
                new Chart(expandedCtx, {
                    type: originalChart.config.type,
                    data: chartData,
                    options: chartOptions
                });
            }
            
            // Close modal functionality
            const closeBtn = modal.querySelector('.chart-modal-close');
            closeBtn.addEventListener('click', () => {
                // Destroy the expanded chart before removing modal
                const expandedCanvas = document.getElementById('expanded-priceSentimentChart');
                if (expandedCanvas) {
                    const expandedChart = Chart.getChart(expandedCanvas);
                    if (expandedChart) {
                        expandedChart.destroy();
                    }
                }
                document.body.removeChild(modal);
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    // Destroy the expanded chart before removing modal
                    const expandedCanvas = document.getElementById('expanded-priceSentimentChart');
                    if (expandedCanvas) {
                        const expandedChart = Chart.getChart(expandedCanvas);
                        if (expandedChart) {
                            expandedChart.destroy();
                        }
                    }
                    document.body.removeChild(modal);
                }
            });
        });
        
        // Show expand icon on hover
        chartContainer.addEventListener('mouseenter', function() {
            const overlay = this.querySelector('.chart-expand-overlay');
            if (overlay) {
                overlay.style.opacity = '1';
            }
        });
        
        chartContainer.addEventListener('mouseleave', function() {
            const overlay = this.querySelector('.chart-expand-overlay');
            if (overlay) {
                overlay.style.opacity = '0';
            }
        });
    }
    
});
</script>
{% endblock %}
